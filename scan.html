<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Scan</title>

  <!-- Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      /* iOS-ish palette */
      --bg: #F2F2F7;
      --card: #FFFFFF;
      --text: #111111;
      --sub: #6B6B73;
      --line: rgba(60, 60, 67, 0.12);

      --ios-blue: #007AFF;
      --ios-blue-press: #0062CC;

      --ios-gray: #E5E5EA;
      --ios-gray-press: #D1D1D6;

      --danger: #FF3B30;
      --danger-press: #D93028;

      --radius: 16px;
      --pad: 16px;
      --max: 760px;

      --btn-h: 52px; /* > 44px touch target */
      --bar-gap: 10px;
      --bar-pad: 12px;

      --shadow: 0 6px 18px rgba(0,0,0,.08);
      --shadow-press: 0 2px 8px rgba(0,0,0,.10);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 14px var(--pad);
      /* reserve space for bottom bar (3 stacked buttons) */
      padding-bottom: calc(
        (var(--btn-h) * 3) + (var(--bar-gap) * 2) + (var(--bar-pad) * 2)
        + env(safe-area-inset-bottom, 0px)
      );
    }

    /* iOS-like nav header */
    header{
      display:flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      margin: 8px 0 12px;
    }

    .title{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.2px;
      margin: 0;
      line-height: 1.1;
    }
    .subtitle{
      margin-top: 6px;
      font-size: 12px;
      color: var(--sub);
      line-height: 1.35;
    }
    .clock{
      font-size: 12px;
      color: var(--sub);
      white-space: nowrap;
      padding-bottom: 4px;
    }

    /* Cards / grouped list */
    .card{
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
    }

    /* Camera */
    .camera{
      background:#000;
    }
    #reader{ width: 100%; }

    /* Status line */
    .status{
      display:flex;
      align-items:center;
      gap: 10px;
      margin: 12px 2px 10px;
      font-size: 13px;
      color: var(--sub);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: #C7C7CC;
    }
    .status.running .dot{ background: #34C759; }

    /* Grouped */
    .group{
      margin-top: 14px;
    }
    .groupTitle{
      font-size: 13px;
      font-weight: 700;
      color: var(--sub);
      margin: 12px 6px 8px;
      letter-spacing: .2px;
    }

    .list{
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
    }

    .listHead{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(242,242,247,.55);
      gap: 12px;
    }

    .count{
      font-size: 12px;
      color: var(--sub);
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .smallBtn{
      height: 30px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ios-blue);
      font-weight: 800;
      font-size: 12px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .smallBtn:active{
      transform: scale(.98);
      opacity: .9;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items:center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
    }
    .row:last-child{ border-bottom:0; }

    .barcode{
      font-size: 15px;
      font-weight: 800;
      word-break: break-all;
    }
    .time{
      font-size: 12px;
      color: var(--sub);
      white-space: nowrap;
    }

    .badge{
      font-size: 11px;
      font-weight: 800;
      color: #fff;
      background: rgba(52,199,89,.95);
      padding: 4px 8px;
      border-radius: 999px;
      justify-self: end;
    }

    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
      color: var(--danger);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{
      background: rgba(255,59,48,.10);
      transform: scale(.96);
    }

    .empty{
      padding: 18px 14px;
      font-size: 13px;
      color: var(--sub);
    }

    /* Latest 3: tighter, more "info" */
    #latestList { box-shadow: none; }
    #latest .row { padding: 10px 14px; }
    #latest .barcode { font-size: 14px; }

    /* Bottom bar: iOS-like */
    .bottomBar{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: var(--bar-pad) var(--pad);
      padding-bottom: calc(var(--bar-pad) + env(safe-area-inset-bottom, 0px));
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-top: 1px solid var(--line);
      z-index: 999;
    }
    .bottomInner{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      flex-direction: column;
      gap: var(--bar-gap);
    }

    /* App-like full-width rectangular buttons */
    .btn{
      width: 100%;
      height: var(--btn-h);
      border-radius: 14px;
      border: 0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      box-shadow: var(--shadow);
      transition: transform .06s ease, background .06s ease, box-shadow .06s ease, opacity .06s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .btn:disabled{
      opacity: .45;
      box-shadow: none;
    }
    .btnPrimary{ background: var(--ios-blue); color:#fff; }
    .btnPrimary:active{
      background: var(--ios-blue-press);
      transform: scale(.985);
      box-shadow: var(--shadow-press);
    }

    .btnSecondary{
      background: var(--ios-gray);
      color: #111;
      box-shadow: none;
      border: 1px solid var(--line);
    }
    .btnSecondary:active{
      background: var(--ios-gray-press);
      transform: scale(.985);
    }

    /* Toast: show above bottom bar */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(
        (var(--btn-h) * 3) + (var(--bar-gap) * 2) + (var(--bar-pad) * 2)
        + env(safe-area-inset-bottom, 0px) + 10px
      );
      background: rgba(0,0,0,.78);
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .15s ease;
      z-index: 1000;
      max-width: min(520px, calc(100% - 32px));
      text-align: center;
    }
    .toast.show{ opacity: 1; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">æƒæ</div>
        <div class="subtitle">
          Printed æ¨¡å¼ï¼šç›¡é‡è¼¸å‡ºã€Œè·Ÿæ¢ç¢¼å°çš„ä¸€æ¨£ã€çš„æ•¸å­—ï¼ˆå¸¸è¦‹ UPC/EAN æœƒæ­£è¦åŒ–ï¼‰<br/>
          æ­·å²æ¸…å–®æœƒä¿å­˜åœ¨æœ¬æ©Ÿï¼ˆé‡é–‹é é¢ä»ä¿ç•™ï¼‰
        </div>
      </div>
      <div class="clock" id="clock"></div>
    </header>

    <!-- Camera -->
    <div class="card camera">
      <div id="reader"></div>
    </div>

    <!-- Latest 3 under camera (always visible) -->
    <div class="group">
      <div class="groupTitle">æœ€æ–°æƒæï¼ˆ3 ç­†ï¼‰</div>
      <div class="list" id="latestList">
        <div class="empty" id="latestEmpty">å°šç„¡è³‡æ–™</div>
        <div id="latest"></div>
      </div>
    </div>

    <!-- Status -->
    <div class="status stopped" id="status">
      <span class="dot" aria-hidden="true"></span>
      <span id="statusText">æœªå•Ÿå‹•</span>
    </div>

    <!-- History -->
    <div class="group">
      <div class="groupTitle">æ­·å²æ¸…å–®</div>
      <div class="list">
        <div class="listHead">
          <div class="count">
            <span><span id="count">0</span> ç­†</span>
          </div>
          <button class="smallBtn" id="btnClear" type="button">æ¸…ç©º</button>
        </div>
        <div id="records">
          <div class="empty" id="empty">å°šç„¡è³‡æ–™ã€‚è«‹é»åº•éƒ¨ã€Œé–‹å§‹æƒæã€ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom action bar -->
  <div class="bottomBar">
    <div class="bottomInner">
      <button class="btn btnPrimary" id="btnStart" type="button">é–‹å§‹æƒæ</button>
      <button class="btn btnSecondary" id="btnStop" type="button" disabled>åœæ­¢æƒæ</button>
      <button class="btn btnPrimary" id="btnExport" type="button">åŒ¯å‡º CSV</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ========= Config =========
    const COOLDOWN_MS = 1500;                 // åŒç¢¼çŸ­æ™‚é–“é¿å…é€£çºŒé‡è¤‡
    const STORE_KEY = "barcode_scanner_history_v3_ios_latest"; // localStorage key
    const LATEST_N = 3;                       // latest preview size

    // ========= State =========
    let scanner = null;
    let isRunning = false;
    let records = [];     // newest first: [{id, barcode, time, format}]
    let lastScanAt = {};  // barcode -> epoch(ms)

    // ========= DOM =========
    const $ = (id) => document.getElementById(id);

    function nowString(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }

    // iOS-like toast
    let toastTimer = null;
    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove("show"), 1200);
    }

    function setStatus(running, text){
      isRunning = running;
      $("status").classList.toggle("running", running);
      $("statusText").textContent = text;

      $("btnStart").disabled = running;
      $("btnStop").disabled = !running;
    }

    function saveHistory(){
      try { localStorage.setItem(STORE_KEY, JSON.stringify(records)); }
      catch(e){ console.warn(e); }
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }

    function renderCount(){
      $("count").textContent = String(records.length);
      $("empty").style.display = records.length === 0 ? "block" : "none";
    }

    // Row for history list (includes delete)
    function historyRowEl(item){
      const row = document.createElement("div");
      row.className = "row";
      row.dataset.id = item.id;

      const barcode = document.createElement("div");
      barcode.className = "barcode";
      barcode.textContent = item.barcode;

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = item.time;

      const del = document.createElement("button");
      del.className = "iconBtn";
      del.type = "button";
      del.title = "åˆªé™¤";
      del.innerHTML = "ğŸ—‘ï¸";
      del.addEventListener("click", () => deleteRecord(item.id));

      row.appendChild(barcode);
      row.appendChild(time);
      row.appendChild(del);

      return row;
    }

    function addToHistoryUI(item){
      const container = $("records");
      container.insertBefore(historyRowEl(item), container.firstChild);
      renderCount();
    }

    function rerenderHistory(){
      const container = $("records");
      container.innerHTML = "";
      if(records.length === 0){
        container.appendChild($("empty"));
      }else{
        for(const r of records){
          container.appendChild(historyRowEl(r));
        }
      }
      renderCount();
    }

    // Latest 3 preview under camera (no delete; focus on quick confirmation)
    function updateLatest(){
      const latestBox = $("latest");
      const latestEmpty = $("latestEmpty");
      latestBox.innerHTML = "";

      const top = records.slice(0, LATEST_N);
      if(top.length === 0){
        latestEmpty.style.display = "block";
        return;
      }
      latestEmpty.style.display = "none";

      top.forEach((r, idx) => {
        const row = document.createElement("div");
        row.className = "row";

        const barcode = document.createElement("div");
        barcode.className = "barcode";
        barcode.textContent = r.barcode;

        const time = document.createElement("div");
        time.className = "time";
        time.textContent = r.time;

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = (idx === 0) ? "NEW" : "";

        row.appendChild(barcode);
        row.appendChild(time);
        row.appendChild(badge);

        latestBox.appendChild(row);
      });
    }

    function deleteRecord(id){
      const idx = records.findIndex(r => r.id === id);
      if(idx === -1) return;

      records.splice(idx, 1);

      const el = $("records").querySelector(`[data-id="${CSS.escape(id)}"]`);
      if(el) el.remove();

      saveHistory();
      renderCount();
      updateLatest();
      toast("å·²åˆªé™¤ 1 ç­†");
    }

    // ========= Printed normalization =========
    // ç›®æ¨™ï¼šç›¡é‡è®“è¼¸å‡ºè²¼è¿‘æ¢ç¢¼ã€Œå°çš„æ•¸å­—ã€(å°¤å…¶ UPC/EAN)
    function normalizeToPrinted(decodedText, formatName){
      if(!decodedText) return "";
      let t = String(decodedText).trim().replace(/[\s-]/g, "");

      const isDigits = /^[0-9]+$/.test(t);
      if(!isDigits) return t; // å«å­—æ¯ä¸äº‚å‹•

      // å¸¸è¦‹ï¼šUPC-A æœƒè¢«è§£æˆ EAN-13 ä¸”å‰é¢è£œ 0
      if(formatName === "EAN_13" && t.length === 13 && t.startsWith("0")){
        return t.slice(1); // è®Šæˆ 12 ç¢¼ï¼Œæ›´æ¥è¿‘ UPC å°åˆ·
      }

      return t; // å…¶ä»–ç¶­æŒåŸæ¨£
    }

    function addRecord(rawText, formatName){
      const printed = normalizeToPrinted(rawText, formatName);
      if(!printed) return;

      const now = Date.now();
      if(lastScanAt[printed] && (now - lastScanAt[printed] < COOLDOWN_MS)) return;
      lastScanAt[printed] = now;

      const item = {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(now) + Math.random().toString(16).slice(2)),
        barcode: printed,
        time: nowString(),
        format: formatName || ""
      };

      records.unshift(item);
      saveHistory();

      // UI updates
      addToHistoryUI(item);
      updateLatest();

      // Feedback
      toast(`âœ… å·²æƒæï¼š${item.barcode}`);

      // Optional haptic (Android works; iOS web may ignore)
      if (navigator.vibrate) navigator.vibrate(20);
    }

    // ========= Scanner =========
    async function startScan(){
      if(isRunning || scanner) return;

      setStatus(true, "å•Ÿå‹•ä¸­â€¦");

      try{
        scanner = new Html5Qrcode("reader");
        await scanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 }, disableFlip: true },
          (decodedText, decodedResult) => {
            const formatName =
              decodedResult && decodedResult.result && decodedResult.result.format
                ? decodedResult.result.format.formatName
                : "";
            addRecord(decodedText, formatName);
          }
        );

        setStatus(true, "æƒæä¸­");
        toast("ç›¸æ©Ÿå·²å•Ÿå‹•");
      }catch(e){
        console.error(e);
        scanner = null;
        setStatus(false, "å•Ÿå‹•å¤±æ•—ï¼ˆè«‹ç¢ºèª HTTPS / ç›¸æ©Ÿæ¬Šé™ï¼‰");
        toast("å•Ÿå‹•å¤±æ•—ï¼šè«‹ç¢ºèªæ¬Šé™");
      }
    }

    async function stopScan(){
      if(!scanner){
        setStatus(false, "æœªå•Ÿå‹•");
        return;
      }
      try{
        await scanner.stop();
        await scanner.clear();
      }catch(e){
        console.error(e);
      }finally{
        scanner = null;
        setStatus(false, "å·²åœæ­¢");
        toast("å·²åœæ­¢");
      }
    }

    function exportCSV(){
      if(records.length === 0){
        toast("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        return;
      }
      let csv = "\uFEFFbarcode,scanned_at\n";
      for(const r of records.slice().reverse()){
        const b = String(r.barcode).replaceAll('"','""');
        csv += `"${b}","${r.time}"\n`;
      }
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `barcode_scans_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast("CSV å·²ä¸‹è¼‰");
    }

    function clearAll(){
      if(!confirm("æ¸…ç©ºæ­·å²æ¸…å–®ï¼Ÿ")) return;
      records = [];
      lastScanAt = {};
      saveHistory();
      rerenderHistory();
      updateLatest();
      toast("å·²æ¸…ç©º");
    }

    // ========= Wire =========
    $("btnStart").addEventListener("click", startScan);
    $("btnStop").addEventListener("click", stopScan);
    $("btnExport").addEventListener("click", exportCSV);
    $("btnClear").addEventListener("click", clearAll);

    // Clock
    function tick(){ $("clock").textContent = nowString(); }
    tick(); setInterval(tick, 1000);

    // Stop camera when hidden (mobile UX)
    document.addEventListener("visibilitychange", () => {
      if(document.hidden) stopScan();
    });

    // Init
    records = loadHistory();
    rerenderHistory();
    updateLatest();
    setStatus(false, "æœªå•Ÿå‹•");
  </script>
</body>
</html>
